# 共変量調整  

## 0. Motivation  

---

従属変数と独立変数だけの分析ではなく、共変量も考慮した分析を行いたい  

### 線形回帰モデルの限界

- 変数を数を増やしていくと、マルチコが発生→適切に推定できない  
- 非線形のモデルを扱えない  
- トリートメントグループとコントロールグループの間で、共変量に偏りがある場合、因果効果を正しく推定できない  

## 1. 傾向スコア(PS)  

---
**お気持ち**  
複数の共変量**C**を1つ(C)に集約できれば、マッチングや層別化を行うことができる  

### PSで因果効果を推定するための条件  

**強く無視できる割り当て条件**：どっちの群に割付られるかは観測される交絡因子（共変量）に依存し，目的変数には依存しない  
$$
\begin{align}
\{Y(1), Y(0)\} \bot T |\bold C \\
0 < P(T=1|\bold C) < 1
\end{align}
$$  
つまり、処置が行われるかどうかは交絡因子（共変量）のみに依存、共変量が全く同じ個体について、2群のどちらに割り当てられるかという確率は全く同じ。  

一般に、交絡因子を用いて式（1）が成立するようにする関数をバランシングスコアといい、そのうちの1つがPS。  

**バランシングスコア**$b(\bold C)$：$$\bold C \bot T |b(\bold C)$$  
つまり、バランシングスコアで条件づけると、交絡因子（共変量）と処置が独立になるような交絡因子Cの関数がバランシングスコア。  

ここで、もし強く無視できる割り当て条件が成立しているなら、$$\{Y(1), Y(0)\} \bot T |b(\bold C)$$が成立する

### PSの概要  

傾向スコア$\pi$は、交絡因子**C**で条件づけられた処置群に属する確率。ただし、未観測の交絡因子が存在しないと仮定する  
$$0 < \pi(\bold C) \equiv P(T=1|\bold C) < 1$$  

**計算方法**  
傾向スコアは、$T$を目的変数として主にロジスティック回帰で計算される。機械学習モデルも使える（分類木等）  

**使い方**  
- **マッチング**：傾向スコア$\pi(\bold C)$が近いトリートメントグループとコントロールグループを比較し、それらの平均値の差を求める  
- **層化**：傾向スコアの大小でいくつかのグループに分け、その各グループ内でトリートメントグループとコントロールグループの平均の差を求める。加えて、全体としての効果の推定量を計算する  
- **共分散分析**：傾向スコアを共変量として共分散分析を行う  
- **重み付け法**：データの各個体に重み付けを行い、トリートメントグループとコントロールグループの分布が似ている疑似母集団を作成する。この重み付けに傾向スコアを用いる。  
  - **逆確率重み付け（IPW）**：トリートメントグループにはPSの逆数で、コントロールグループには１－PSの逆数で重み付け  
  ATEの推定値は、$$\frac{1}{n}\sum_{i=1}^n\frac{T_iY_i}{\hat{\pi}(X_i)} - \frac{1}{n}\sum_{i=1}^n\frac{(1-T_i)Y_i}{1- \hat{\pi}(X_i)}$$で計算される。（ただし、Causallibはもう一つの計算方法を適用している（実装コード参照））  

#### 共変量と傾向スコアの評価  

1. 絶対標準化平均差（ASMD）：
$$
\begin{align}SMD &= \frac{\bar{X}_{treatment} - \bar{X}_{control}}{\sigma_{pool}}\\
            \sigma_{pool}^2 &= \frac{(N_{treatment}-1)\sigma_{treatment}^2 + (N_{control}-1)\sigma_{control}^2}{N_{treatment}+N_{control}-2}
\end{align}
$$  
$\bar{X}$は共変量の平均値、$N$は個体数、$\sigma^2$は共変量の分散を表す。SMD（標準化平均差）は、両群の共変量の平均の差が小さければ、標準偏差が大きければ、小さい値をとる。SMDが小さいということは、両群の共変量が似た分布を持っている、すなわち、適切な比較を行えるということ。SMDの絶対値を取ったものがASMDで、0.1未満が推奨されている  

2. 分散比：共変量の分散比が１に近いほどバランスがよいことを示す  

3. 分布を目視：傾向スコアごとの度数をみるヒストグラムを用いて、両群におけるその分布を確認する  

### PSの課題  

- 未観測の交絡因子の存在  
- ロジスティック回帰のための仮定が満たされない  
- 傾向スコアの分布の分散が過分散（割り当ての確率が極端になり、重み付けした値に影響してしまう）$\to$ Clippingで対処  
